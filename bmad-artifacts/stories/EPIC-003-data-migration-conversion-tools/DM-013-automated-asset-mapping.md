# User Story: Automated Asset Mapping from Table Data

**Epic**: [EPIC-003: Data Migration & Conversion Tools](bmad-artifacts/epics/EPIC-003-data-migration-conversion-tools.md)  
**Story ID**: DM-013  
**Created**: 2025-06-09  
**Updated**: 2025-06-10  
**Status**: Completed

## Story Definition
**As a**: Conversion Manager  
**I want**: the conversion tool to automatically generate a detailed asset conversion map by parsing WCS table files (`.tbl`), with its logic informed by manual analysis of the C++ source code,  
**So that**: we can create a complete and accurate asset map that captures both data-driven and hardcoded asset dependencies.

## Acceptance Criteria
- [x] **AC1**: The `AssetMapper` class is extended to parse WCS `.tbl` files (like `ships.tbl`) to discover data-driven asset relationships.
- [x] **AC2**: The `AssetMapper`'s implementation correctly handles known hardcoded asset relationships discovered through manual analysis of the C++ source code.
- [x] **AC3**: The `AssetMapper` generates a `project_mapping.json` file that defines source-to-target paths and conversion types for all related assets, combining data from `.tbl` files and hardcoded logic.
- [x] **AC4**: The final `project_mapping.json` generated by the mapper accurately reflects the combined dependencies, linking all related assets to their parent entities (like ships or missions).

## Technical Requirements
- **Architecture Reference**: Extends `table_converter.py` and `migration_manager.py` from `bmad-artifacts/docs/EPIC-003-data-migration-conversion-tools/architecture.md`.
- **Godot Components**: Output will be consumed by `GodotProjectIntegrator` for semantic file organization.
- **Integration Points**: This provides a more robust implementation strategy for `DM-008: Asset Table Processing`.

## Implementation Notes
- **WCS Reference**: 
    - Table files: `ships.tbl`, `weapons.tbl`, etc.
    - C++ Source: The developer must manually analyze `source/code/**/*.cpp` to find hardcoded asset names (e.g., string literals ending in `.pof`, `.dds`) and incorporate this logic into the mapper.
- **Godot Approach**: Implement a robust table parser in Python. The mapper's logic will contain hardcoded rules and additions based on the manual C++ code review.
- **Key Challenges**: 
    - Ensuring the manual C++ code analysis is thorough.
    - Designing the `AssetMapper` to be easily extendable with new hardcoded rules as they are discovered.
- **Success Metrics**: The generated map for the Hermes campaign is at least 98% complete, requiring minimal manual correction.

## Dependencies
- **Prerequisites**: `DM-004: POF Format Analysis and Parser`.
- **Blockers**: None.
- **Related Stories**: This is a detailed implementation for `DM-008`. It will be used by `DM-015`.

## Definition of Done
- [x] All acceptance criteria met and verified.
- [x] Code follows Python standards with type hinting.
- [x] Unit tests cover table parsing and the application of hardcoded mapping rules.
- [x] The generated `project_mapping.json` is validated against a schema.
- [x] Code reviewed and approved by Mo (Godot Architect) and Larry (WCS Analyst).

## Implementation Summary
**Completed**: 2025-06-10  
**Files Created**:
- `target/conversion_tools/asset_relationship_mapper.py` - Complete AssetRelationshipMapper implementation
- `target/conversion_tools/tests/test_asset_relationship_mapper.py` - Comprehensive test suite (12 tests, all passing)

**Files Modified**:
- `target/conversion_tools/conversion_manager.py` - Added AssetRelationshipMapper integration

**Key Features Implemented**:
- **AssetRelationshipMapper class** with comprehensive table parsing for ships.tbl and weapons.tbl
- **HardcodedAssetMappings class** containing manual C++ source analysis findings:
  - Texture format mappings (from bmpman.cpp)
  - Weapon effect mappings (from weapons.cpp) 
  - Ship subsystem mappings (from ship.cpp)
  - Common asset naming patterns and campaign overrides
- **Complete project_mapping.json generation** with entity mappings, asset index, and statistics
- **Target path generation** following target/assets/CLAUDE.md structure (campaigns/ships/factions/classes)
- **CLI integration** via `--mapping-only` flag in conversion_manager.py
- **Faction/class determination** using hardcoded patterns (Terran/Kilrathi, fighters/capital_ships)

**Manual C++ Analysis Incorporated**:
- Texture suffix patterns (_glow, _normal, _spec, _reflect, _shine, _thruster)
- Weapon effect naming conventions (wpn_, missile_, impact_, trail_, exhaust_)
- Ship subsystem associations (engine glow, turret models, fire sounds)
- Campaign-specific prefixes (Hermes: h_, hw_, hm_)

**Output Format**: Complete JSON mapping with metadata, entity mappings, asset index, missing assets tracking, and conversion statistics.

## Estimation
- **Complexity**: Complex
- **Effort**: 3 days
- **Risk Level**: Medium
- **Confidence**: Medium
